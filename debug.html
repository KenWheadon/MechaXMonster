<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mecha X Monster - Debug Interface</title>

    <!-- Load CSS Files -->
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/startscreen.css" />
    <link rel="stylesheet" href="css/mapscreen.css" />
    <link rel="stylesheet" href="css/miningscreen.css" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
        min-height: 100vh;
        color: white;
      }

      /* Debug Panel */
      .debug-panel {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.9);
        padding: 20px;
        border-radius: 10px;
        z-index: 1000;
        border: 2px solid #00ff88;
        min-width: 220px;
        backdrop-filter: blur(10px);
      }

      .debug-panel h3 {
        color: #00ff88;
        margin-bottom: 15px;
        font-size: 16px;
        text-align: center;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
      }

      .debug-btn {
        display: block;
        width: 100%;
        margin: 8px 0;
        padding: 12px;
        background: rgba(51, 51, 51, 0.8);
        color: white;
        border: 2px solid #555;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        text-align: center;
        backdrop-filter: blur(5px);
      }

      .debug-btn:hover {
        background: rgba(85, 85, 85, 0.9);
        border-color: #00ff88;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2);
      }

      .debug-btn:active {
        transform: translateY(0);
      }

      .debug-btn.active {
        background: #00ff88;
        color: black;
        border-color: #00ff88;
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
      }

      .debug-btn.loading {
        background: #ffaa00;
        color: black;
        border-color: #ffaa00;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .debug-info {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #555;
        font-size: 12px;
        color: #aaa;
      }

      .debug-info div {
        margin: 5px 0;
        display: flex;
        justify-content: space-between;
      }

      .debug-info span {
        color: #00ff88;
        font-weight: bold;
      }

      .debug-controls {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #555;
      }

      .debug-controls h4 {
        color: #00ccff;
        font-size: 12px;
        margin-bottom: 10px;
        text-align: center;
      }

      .debug-mini-btn {
        display: inline-block;
        width: 48%;
        margin: 2px 1%;
        padding: 8px 4px;
        background: rgba(51, 51, 51, 0.6);
        color: white;
        border: 1px solid #555;
        border-radius: 3px;
        cursor: pointer;
        font-size: 10px;
        text-align: center;
        transition: all 0.2s ease;
      }

      .debug-mini-btn:hover {
        background: rgba(85, 85, 85, 0.8);
        border-color: #00ccff;
      }

      .debug-mini-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Mine selector for MiningScreen */
      .mine-selector {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #333;
      }

      .mine-selector h5 {
        color: #00ccff;
        font-size: 10px;
        margin-bottom: 5px;
        text-align: center;
      }

      .mine-selector select {
        width: 100%;
        padding: 5px;
        background: rgba(51, 51, 51, 0.8);
        color: white;
        border: 1px solid #555;
        border-radius: 3px;
        font-size: 11px;
      }

      /* Game Container */
      #game-container {
        width: 100%;
        height: 100vh;
        position: relative;
        overflow: hidden;
      }

      /* Placeholder screen */
      .placeholder-screen {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        text-align: center;
        background: radial-gradient(
          ellipse at center,
          #0a0a1a 0%,
          #000000 100%
        );
      }

      .placeholder-content {
        background: rgba(0, 0, 0, 0.8);
        padding: 40px;
        border-radius: 15px;
        border: 2px solid #555;
        backdrop-filter: blur(10px);
      }

      .placeholder-content h2 {
        color: #00ff88;
        margin-bottom: 20px;
        font-size: 2rem;
        text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
      }

      .placeholder-content p {
        color: #aaa;
        font-size: 1.1rem;
        margin-bottom: 10px;
      }

      .error-content {
        border-color: #ff6b6b !important;
      }

      .error-content h2 {
        color: #ff6b6b !important;
        text-shadow: 0 0 20px rgba(255, 107, 107, 0.5) !important;
      }

      .error-content p {
        color: #ffaaaa !important;
      }

      /* Loading indicator */
      .loading-indicator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        padding: 30px;
        border-radius: 15px;
        border: 2px solid #00ff88;
        z-index: 999;
        text-align: center;
        backdrop-filter: blur(10px);
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0, 255, 136, 0.3);
        border-top: 4px solid #00ff88;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        color: #00ff88;
        font-weight: bold;
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <!-- Loading Indicator -->
    <div class="loading-indicator hidden" id="loading-indicator">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading...</div>
    </div>

    <!-- Debug Panel -->
    <div class="debug-panel">
      <h3>üêõ Debug Interface</h3>
      <button class="debug-btn" data-screen="start" data-file="startscreen.js">
        üöÄ Start Screen
      </button>
      <button class="debug-btn" data-screen="map" data-file="mapscreen.js">
        üó∫Ô∏è Map Screen
      </button>
      <button
        class="debug-btn"
        data-screen="mining"
        data-file="miningscreen.js"
      >
        ‚õèÔ∏è Mining Screen
      </button>

      <!-- Mine selector for MiningScreen -->
      <div class="mine-selector" id="mine-selector" style="display: none">
        <h5>Select Mine:</h5>
        <select id="mine-select">
          <option value="mine1">Mine 1 (Rock Mine)</option>
          <option value="mine2">Mine 2 (Ice Mine)</option>
          <option value="mine3">Mine 3 (Crystal Mine)</option>
          <option value="mine4">Mine 4 (Gas Mine)</option>
          <option value="mine5">Mine 5 (Rare Earth Mine)</option>
        </select>
      </div>

      <button
        class="debug-btn"
        data-screen="combat"
        data-file="combatscreen.js"
      >
        ‚öîÔ∏è Combat Screen
      </button>
      <button
        class="debug-btn"
        data-screen="trading"
        data-file="tradingscreen.js"
      >
        üè™ Trading Post
      </button>

      <div class="debug-info">
        <div>Current: <span id="current-screen">None</span></div>
        <div>Status: <span id="debug-status">Ready</span></div>
        <div>Loaded: <span id="loaded-count">0</span></div>
      </div>

      <div class="debug-controls">
        <h4>Screen Controls</h4>
        <button class="debug-mini-btn" id="skip-to-click" disabled>
          Skip to Click
        </button>
        <button class="debug-mini-btn" id="skip-to-main" disabled>
          Skip to Main
        </button>
        <button class="debug-mini-btn" id="debug-info-btn" disabled>
          Debug Info
        </button>
        <button class="debug-mini-btn" id="reset-screen" disabled>
          Reset Screen
        </button>
        <button class="debug-mini-btn" id="add-currency" disabled>
          Add Currency
        </button>
        <button class="debug-mini-btn" id="unlock-mines" disabled>
          Unlock All
        </button>
        <button class="debug-mini-btn" id="add-parts" disabled>
          Add Parts
        </button>
        <button class="debug-mini-btn" id="add-geodes" disabled>
          Add Geodes
        </button>
      </div>
    </div>

    <!-- Game Container -->
    <div id="game-container">
      <div class="screen placeholder-screen active" id="default-screen">
        <div class="placeholder-content">
          <h2>Mecha X Monster</h2>
          <p>Select a screen from the debug panel to test</p>
          <p style="font-size: 0.9rem; margin-top: 15px">
            Make sure you have the following files:
          </p>
          <p style="font-size: 0.8rem; color: #666">
            js/screen.js, js/startscreen.js, js/mapscreen.js,
            js/miningscreen.js<br />
            css/styles.css, css/startscreen.css, css/mapscreen.css,
            css/miningscreen.css
          </p>
        </div>
      </div>
    </div>

    <!-- Load Scripts in Order -->
    <script src="js/config.js"></script>
    <script src="js/screen.js"></script>
    <script>
      // Debug System - Enhanced for refactored screen system
      class DebugSystem {
        constructor() {
          this.currentScreen = null;
          this.loadedScreens = new Map();
          this.loadedScripts = new Set();
          this.isLoading = false;
          this.selectedMine = "mine1"; // Default mine for MiningScreen
          this.init();
        }

        init() {
          this.setupEventListeners();
          this.updateStatus("Ready - Select a screen to test");
          this.updateLoadedCount();
          console.log("üêõ Debug System initialized");

          // Check if base Screen class is available
          if (typeof Screen === "undefined") {
            this.updateStatus("Error: Screen.js not loaded");
            console.error("Screen.js must be loaded before debug system");
          }
        }

        setupEventListeners() {
          // Main screen buttons
          document.querySelectorAll(".debug-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              if (this.isLoading) return;

              const screenName = e.target.dataset.screen;
              const fileName = e.target.dataset.file;

              // Show mine selector for mining screen
              if (screenName === "mining") {
                this.showMineSelector();
              } else {
                this.hideMineSelector();
              }

              await this.loadScreen(screenName, fileName);
              this.updateDebugButtons(e.target);
            });
          });

          // Mine selector change
          document
            .getElementById("mine-select")
            .addEventListener("change", (e) => {
              this.selectedMine = e.target.value;
              // If mining screen is currently active, reload it with new mine
              if (
                this.currentScreen &&
                this.currentScreen.constructor.name === "MiningScreen"
              ) {
                this.loadScreen("mining", "miningscreen.js");
              }
            });

          // Debug control buttons
          document
            .getElementById("skip-to-click")
            .addEventListener("click", () => {
              if (this.currentScreen && this.currentScreen.skipToClickGame) {
                this.currentScreen.skipToClickGame();
                this.updateStatus("Skipped to click game");
              }
            });

          document
            .getElementById("skip-to-main")
            .addEventListener("click", () => {
              if (this.currentScreen && this.currentScreen.skipToMainScreen) {
                this.currentScreen.skipToMainScreen();
                this.updateStatus("Skipped to main screen");
              }
            });

          document
            .getElementById("debug-info-btn")
            .addEventListener("click", () => {
              if (this.currentScreen && this.currentScreen.debug) {
                this.currentScreen.debug();
                this.updateStatus("Debug info logged to console");
              }
            });

          document
            .getElementById("reset-screen")
            .addEventListener("click", () => {
              if (this.currentScreen) {
                this.resetCurrentScreen();
              }
            });

          // MapScreen specific controls
          document
            .getElementById("add-currency")
            .addEventListener("click", () => {
              if (this.currentScreen && this.currentScreen.addCurrency) {
                this.currentScreen.addCurrency("shells", 100);
                this.currentScreen.addCurrency("monster_shells", 10);
                this.updateStatus("Added test currencies");
              }
            });

          document
            .getElementById("unlock-mines")
            .addEventListener("click", () => {
              if (this.currentScreen && this.currentScreen.unlockAllMines) {
                this.currentScreen.unlockAllMines();
                this.updateStatus("All mines unlocked");
              }
            });

          // MiningScreen specific controls
          document.getElementById("add-parts").addEventListener("click", () => {
            if (this.currentScreen && this.currentScreen.addPart) {
              const mineConfig = GAME_CONFIG.mines[this.selectedMine];
              const mechaType = mineConfig.mecha;
              const partName = `${mechaType}-1`;
              this.currentScreen.addPart(partName);
              this.updateStatus(`Added ${partName} part`);
            }
          });

          document
            .getElementById("add-geodes")
            .addEventListener("click", () => {
              if (this.currentScreen && this.currentScreen.addGeode) {
                this.currentScreen.addGeode("machine1");
                this.updateStatus("Added geode to machine1");
              }
            });
        }

        showMineSelector() {
          document.getElementById("mine-selector").style.display = "block";
        }

        hideMineSelector() {
          document.getElementById("mine-selector").style.display = "none";
        }

        async loadScreen(screenName, fileName) {
          try {
            this.isLoading = true;
            this.showLoadingIndicator(`Loading ${screenName}...`);
            this.updateStatus(`Loading ${screenName}...`);

            // Set button to loading state
            const btn = document.querySelector(`[data-screen="${screenName}"]`);
            if (btn) btn.classList.add("loading");

            // Destroy current screen if exists
            if (this.currentScreen && this.currentScreen.destroy) {
              this.currentScreen.destroy();
            }

            // Hide all screens
            document.querySelectorAll(".screen").forEach((screen) => {
              screen.classList.remove("active");
            });

            // Load screen file if not already loaded
            if (!this.loadedScreens.has(screenName)) {
              await this.loadScript(`js/${fileName}`);
              this.loadedScreens.set(screenName, true);
              this.updateLoadedCount();
            }

            // Create screen instance
            const container = document.getElementById("game-container");

            // Check if screen class exists
            const screenClassName = this.getScreenClassName(screenName);
            if (window[screenClassName]) {
              // Special handling for MiningScreen which takes a mine parameter
              if (screenName === "mining") {
                this.currentScreen = new window[screenClassName](
                  container,
                  this.selectedMine
                );
              } else {
                this.currentScreen = new window[screenClassName](container);
              }

              this.currentScreen.init();

              this.updateStatus(`${screenName} loaded successfully`);
              this.updateCurrentScreen(screenName);
              this.updateDebugControls(screenName);
            } else {
              throw new Error(`Screen class ${screenClassName} not found`);
            }
          } catch (error) {
            console.error(`Failed to load ${screenName}:`, error);
            this.updateStatus(`Error loading ${screenName}: ${error.message}`);
            this.showErrorScreen(screenName, error.message);
          } finally {
            this.isLoading = false;
            this.hideLoadingIndicator();

            // Remove loading state from buttons
            document.querySelectorAll(".debug-btn").forEach((btn) => {
              btn.classList.remove("loading");
            });
          }
        }

        loadScript(fileName) {
          return new Promise((resolve, reject) => {
            // Check if script already exists
            if (this.loadedScripts.has(fileName)) {
              resolve();
              return;
            }

            const script = document.createElement("script");
            script.src = fileName;
            script.onload = () => {
              this.loadedScripts.add(fileName);
              resolve();
            };
            script.onerror = () =>
              reject(new Error(`Failed to load ${fileName}`));
            document.head.appendChild(script);
          });
        }

        getScreenClassName(screenName) {
          // Handle special cases
          if (screenName === "start") {
            return "StartScreen";
          }
          if (screenName === "map") {
            return "MapScreen";
          }
          if (screenName === "mining") {
            return "MiningScreen";
          }

          // Convert kebab-case to PascalCase
          return (
            screenName
              .split("-")
              .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
              .join("") + "Screen"
          );
        }

        showErrorScreen(screenName, errorMessage) {
          const container = document.getElementById("game-container");
          container.innerHTML = `
            <div class="screen placeholder-screen active">
              <div class="placeholder-content error-content">
                <h2>‚ùå Error Loading ${screenName}</h2>
                <p style="margin-top: 15px;">${errorMessage}</p>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #999;">
                  Make sure js/${screenName}screen.js exists and extends Screen class
                </p>
                <p style="margin-top: 5px; font-size: 0.8rem; color: #666;">
                  Check the console for more details
                </p>
              </div>
            </div>
          `;
        }

        showLoadingIndicator(text) {
          const indicator = document.getElementById("loading-indicator");
          const textEl = indicator.querySelector(".loading-text");
          textEl.textContent = text;
          indicator.classList.remove("hidden");
        }

        hideLoadingIndicator() {
          const indicator = document.getElementById("loading-indicator");
          indicator.classList.add("hidden");
        }

        updateDebugButtons(activeBtn) {
          document.querySelectorAll(".debug-btn").forEach((btn) => {
            btn.classList.remove("active");
          });
          if (activeBtn) {
            activeBtn.classList.add("active");
          }
        }

        updateDebugControls(screenName) {
          const controls = document.querySelectorAll(".debug-mini-btn");

          // Reset all controls
          controls.forEach((control) => (control.disabled = true));

          if (screenName === "start") {
            // Enable StartScreen specific controls
            document.getElementById("skip-to-click").disabled = false;
            document.getElementById("skip-to-main").disabled = false;
            document.getElementById("debug-info-btn").disabled = false;
            document.getElementById("reset-screen").disabled = false;
          } else if (screenName === "map") {
            // Enable MapScreen specific controls
            document.getElementById("debug-info-btn").disabled = false;
            document.getElementById("reset-screen").disabled = false;
            document.getElementById("add-currency").disabled = false;
            document.getElementById("unlock-mines").disabled = false;
          } else if (screenName === "mining") {
            // Enable MiningScreen specific controls
            document.getElementById("debug-info-btn").disabled = false;
            document.getElementById("reset-screen").disabled = false;
            document.getElementById("add-currency").disabled = false;
            document.getElementById("add-parts").disabled = false;
            document.getElementById("add-geodes").disabled = false;
          } else {
            // Generic controls for other screens
            document.getElementById("debug-info-btn").disabled = false;
            document.getElementById("reset-screen").disabled = false;
          }
        }

        resetCurrentScreen() {
          if (this.currentScreen) {
            const screenName =
              document.getElementById("current-screen").textContent;
            this.currentScreen.destroy();

            // Find the active button and reload the screen
            const activeBtn = document.querySelector(".debug-btn.active");
            if (activeBtn) {
              const fileName = activeBtn.dataset.file;
              this.loadScreen(screenName.toLowerCase(), fileName);
            }

            this.updateStatus(`${screenName} reset`);
          }
        }

        updateStatus(status) {
          document.getElementById("debug-status").textContent = status;
        }

        updateCurrentScreen(screenName) {
          const displayName =
            screenName === "mining"
              ? `${screenName} (${this.selectedMine})`
              : screenName;
          document.getElementById("current-screen").textContent = displayName;
        }

        updateLoadedCount() {
          document.getElementById("loaded-count").textContent =
            this.loadedScreens.size;
        }

        // Public API for console debugging
        getCurrentScreen() {
          return this.currentScreen;
        }

        getLoadedScreens() {
          return Array.from(this.loadedScreens.keys());
        }

        getDebugInfo() {
          return {
            currentScreen: this.currentScreen?.constructor.name || "None",
            selectedMine: this.selectedMine,
            loadedScreens: this.getLoadedScreens(),
            loadedScripts: Array.from(this.loadedScripts),
            isLoading: this.isLoading,
            screenState: this.currentScreen
              ? {
                  isActive: this.currentScreen.isActive,
                  gamePhase: this.currentScreen.gamePhase,
                  clickCount: this.currentScreen.clickCount,
                  energyLevel: this.currentScreen.energyLevel,
                  mineId: this.currentScreen.mineId,
                  currency: this.currentScreen.currency,
                  collectedParts: this.currentScreen.collectedParts,
                  hasMecha: this.currentScreen.hasMecha,
                }
              : null,
          };
        }
      }

      // Initialize debug system when DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        window.debugSystem = new DebugSystem();

        // Add console helpers
        window.debug = {
          system: () => window.debugSystem,
          screen: () => window.debugSystem.getCurrentScreen(),
          info: () => window.debugSystem.getDebugInfo(),
          skip: {
            toClick: () =>
              window.debugSystem.getCurrentScreen()?.skipToClickGame(),
            toMain: () =>
              window.debugSystem.getCurrentScreen()?.skipToMainScreen(),
          },
          reset: () => window.debugSystem.resetCurrentScreen(),
          map: {
            addCurrency: (currency, amount) =>
              window.debugSystem
                .getCurrentScreen()
                ?.addCurrency(currency, amount),
            unlockMine: (mineId) =>
              window.debugSystem.getCurrentScreen()?.unlockMine(mineId),
            unlockAll: () =>
              window.debugSystem.getCurrentScreen()?.unlockAllMines(),
            setCurrency: (currency, amount) =>
              window.debugSystem
                .getCurrentScreen()
                ?.setCurrency(currency, amount),
          },
          mining: {
            addCurrency: (amount) =>
              window.debugSystem.getCurrentScreen()?.addCurrency(amount),
            addPart: (partName) =>
              window.debugSystem.getCurrentScreen()?.addPart(partName),
            addGeode: (machineId) =>
              window.debugSystem.getCurrentScreen()?.addGeode(machineId),
            addAllParts: () => {
              const screen = window.debugSystem.getCurrentScreen();
              if (screen && screen.mineConfig) {
                const mechaType = screen.mineConfig.mecha;
                for (let i = 1; i <= 6; i++) {
                  screen.addPart(`${mechaType}-${i}`);
                }
              }
            },
            fillEnergy: (machineId = "machine1") => {
              const screen = window.debugSystem.getCurrentScreen();
              if (screen && screen.machines) {
                const machine = screen.machines.find((m) => m.id === machineId);
                if (machine) {
                  machine.energyLevel = 100;
                  screen.updateMachineUI(machine);
                }
              }
            },
          },
        };

        console.log(
          "üêõ Debug System loaded. Use window.debug for console access."
        );
      });
    </script>
  </body>
</html>

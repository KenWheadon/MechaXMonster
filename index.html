<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mecha X Monster</title>
    <style>
      /* CSS Custom Properties */
      :root {
        --primary-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        --secondary-gradient: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        --mining-gradient: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        --mecha-gradient: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        --danger-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);

        --background-overlay: rgba(0, 0, 0, 0.3);
        --card-background: rgba(255, 255, 255, 0.2);
        --card-background-hover: rgba(255, 255, 255, 0.3);

        --text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);

        --border-radius: 15px;
        --border-radius-large: 20px;
        --border-radius-small: 10px;

        --transition-fast: 0.1s;
        --transition-normal: 0.3s;
        --transition-slow: 0.8s;

        --font-family: "Comic Sans MS", cursive, sans-serif;
      }

      /* Base Styles */
      * {
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-family);
        background: var(--primary-gradient);
        color: white;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Game Container */
      .game-container {
        background: var(--background-overlay);
        border-radius: var(--border-radius-large);
        padding: 30px;
        max-width: 900px;
        width: 100%;
        box-shadow: var(--box-shadow);
        position: relative;
        min-height: 600px;
      }

      /* Screen Management */
      .screen {
        display: none;
      }

      .screen.active {
        display: block;
      }

      /* Typography */
      h1,
      h2 {
        text-align: center;
        text-shadow: var(--text-shadow);
        margin: 0 0 20px 0;
      }

      h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        color: #f39c12;
      }

      h2 {
        font-size: 2em;
        color: #3498db;
      }

      /* Buttons */
      .btn {
        background: var(--secondary-gradient);
        border: none;
        color: white;
        padding: 15px 30px;
        border-radius: var(--border-radius-small);
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all var(--transition-normal);
        font-family: var(--font-family);
        text-shadow: var(--text-shadow);
      }

      .btn:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-large {
        font-size: 24px;
        padding: 20px 40px;
      }

      /* Start Screen */
      #start-screen {
        text-align: center;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="%23fff" opacity="0.3"/><circle cx="80" cy="40" r="1" fill="%23fff" opacity="0.5"/><circle cx="40" cy="80" r="1.5" fill="%23fff" opacity="0.4"/></svg>')
          no-repeat;
        background-size: cover;
      }

      .tagline {
        font-size: 18px;
        color: #ecf0f1;
        margin: 20px 0;
        font-style: italic;
      }

      /* Mine Selection */
      .mine-map {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .mine-location {
        background: var(--card-background);
        border: 3px solid #3498db;
        border-radius: var(--border-radius);
        padding: 20px;
        cursor: pointer;
        transition: all var(--transition-normal);
        text-align: center;
        position: relative;
      }

      .mine-location:hover {
        transform: scale(1.05);
        background: var(--card-background-hover);
        border-color: #f39c12;
      }

      .mine-location.locked {
        opacity: 0.6;
        border-color: #95a5a6;
        cursor: not-allowed;
      }

      .mine-location.locked:hover {
        transform: none;
        background: var(--card-background);
        border-color: #95a5a6;
      }

      .mine-name {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #f39c12;
      }

      .mine-cost {
        font-size: 14px;
        color: #ecf0f1;
        margin-bottom: 15px;
      }

      .mine-preview {
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin: 15px 0;
      }

      .mecha-preview,
      .monster-preview {
        text-align: center;
      }

      .mecha-preview img,
      .monster-preview img {
        width: 60px;
        height: 60px;
        object-fit: contain;
        border-radius: 50%;
        border: 2px solid #3498db;
      }

      /* Mining Screen */
      .mining-interface {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 30px;
        margin-top: 20px;
      }

      .mining-area {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 20px;
      }

      .mining-machine {
        background: var(--mining-gradient);
        border: 3px solid #27ae60;
        border-radius: var(--border-radius);
        padding: 20px;
        margin: 15px 0;
        cursor: pointer;
        transition: all var(--transition-normal);
        text-align: center;
        position: relative;
      }

      .mining-machine:hover {
        transform: scale(1.02);
        box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
      }

      .mining-machine.active {
        animation: mining-pulse 2s infinite;
      }

      @keyframes mining-pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .progress-bar {
        background: rgba(0, 0, 0, 0.3);
        border-radius: var(--border-radius-small);
        height: 20px;
        margin: 10px 0;
        overflow: hidden;
      }

      .progress-fill {
        background: linear-gradient(90deg, #f39c12, #e67e22);
        height: 100%;
        width: 0%;
        transition: width 0.5s ease;
      }

      .currency-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: var(--border-radius-small);
      }

      .currency-amount {
        font-size: 18px;
        font-weight: bold;
        color: #f39c12;
      }

      /* Mecha Building */
      .mecha-building {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 20px;
      }

      .mecha-display {
        text-align: center;
        margin: 20px 0;
      }

      .mecha-image {
        width: 120px;
        height: 120px;
        object-fit: contain;
        border: 3px solid #3498db;
        border-radius: var(--border-radius);
        background: rgba(52, 152, 219, 0.1);
      }

      .parts-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin: 20px 0;
      }

      .part-slot {
        background: rgba(0, 0, 0, 0.3);
        border: 2px dashed #95a5a6;
        border-radius: var(--border-radius-small);
        padding: 15px;
        text-align: center;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .part-slot.filled {
        background: rgba(46, 204, 113, 0.2);
        border-color: #27ae60;
        border-style: solid;
      }

      .part-name {
        font-size: 12px;
        color: #bdc3c7;
        margin-top: 5px;
      }

      .build-mecha-btn {
        background: var(--mecha-gradient);
        width: 100%;
        margin-top: 20px;
      }

      /* Combat Integration */
      .combat-ready {
        background: var(--danger-gradient);
        border: 3px solid #e74c3c;
        border-radius: var(--border-radius);
        padding: 15px;
        margin: 20px 0;
        text-align: center;
      }

      .monster-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 15px 0;
      }

      .monster-image {
        width: 60px;
        height: 60px;
        object-fit: contain;
        border-radius: 50%;
      }

      /* Trading Post */
      .trading-post {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 20px;
        margin: 20px 0;
      }

      .exchange-rates {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .exchange-option {
        background: rgba(0, 0, 0, 0.2);
        border-radius: var(--border-radius-small);
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-normal);
      }

      .exchange-option:hover {
        background: rgba(0, 0, 0, 0.3);
        transform: scale(1.02);
      }

      /* Battle Screen (inherited from combat.js) */
      .battle-arena {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin: 20px 0;
      }

      .fighter-card {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 20px;
        flex: 1;
        text-align: center;
      }

      .fighter-sprite {
        width: 80px;
        height: 80px;
        object-fit: contain;
        margin: 10px 0;
      }

      .stats {
        margin: 10px 0;
      }

      .stat-bar {
        background: var(--background-overlay);
        border-radius: var(--border-radius-small);
        height: 20px;
        margin: 5px 0;
        overflow: hidden;
      }

      .stat-fill {
        height: 100%;
        transition: width var(--transition-normal);
      }

      .hp-fill {
        background: linear-gradient(90deg, #e74c3c, #c0392b);
      }

      .energy-fill {
        background: linear-gradient(90deg, #3498db, #2980b9);
      }

      .move-buttons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-top: 20px;
      }

      .move-btn {
        background: var(--mecha-gradient);
        border: none;
        color: white;
        padding: 15px;
        border-radius: var(--border-radius-small);
        cursor: pointer;
        font-size: 14px;
        transition: all var(--transition-normal);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }

      .move-btn:hover:not(:disabled) {
        transform: scale(1.05);
      }

      .move-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .move-icon {
        width: 24px;
        height: 24px;
        object-fit: contain;
      }

      /* Training/Upgrades */
      .training-area {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 20px;
        margin: 20px 0;
      }

      .bubble-clicker {
        position: relative;
        height: 300px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: var(--border-radius);
        overflow: hidden;
        margin: 20px 0;
      }

      .bubble {
        position: absolute;
        width: 60px;
        height: 60px;
        background: var(--secondary-gradient);
        border-radius: 50%;
        cursor: pointer;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }

      .bubble:hover {
        transform: scale(1.2);
      }

      /* Slots Machine */
      .slots-container {
        background: var(--card-background);
        border-radius: var(--border-radius);
        padding: 20px;
        margin: 20px 0;
        text-align: center;
      }

      .slots-reels {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
      }

      .slot-reel {
        background: var(--background-overlay);
        border-radius: var(--border-radius-small);
        padding: 20px;
        font-size: 32px;
        min-width: 80px;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .spinning {
        animation: spin 0.1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotateY(360deg);
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .mining-interface {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .mine-map {
          grid-template-columns: 1fr;
        }

        .move-buttons {
          grid-template-columns: repeat(2, 1fr);
        }

        .battle-arena {
          flex-direction: column;
        }
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-out;
      }

      /* Popup styles */
      .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        border: 3px solid #f39c12;
        border-radius: var(--border-radius-large);
        padding: 30px;
        z-index: 1000;
        max-width: 500px;
        width: 90%;
        text-align: center;
      }

      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 999;
      }

      /* Log/Messages */
      .game-log {
        background: var(--background-overlay);
        border-radius: var(--border-radius-small);
        padding: 15px;
        height: 150px;
        overflow-y: auto;
        margin: 20px 0;
        font-size: 14px;
        line-height: 1.4;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 2px 0;
      }

      .log-entry.important {
        color: #f39c12;
        font-weight: bold;
      }

      .log-entry.combat {
        color: #e74c3c;
      }

      .log-entry.success {
        color: #27ae60;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <!-- Start Screen -->
      <div id="start-screen" class="screen active">
        <h1>ü§ñ MECHA X MONSTER ü§ñ</h1>
        <p class="tagline">Can You Stop the Evil Slime?</p>
        <p>
          Welcome to the asteroid mining colony! The evil slimes have taken over
          our mining operations. Build powerful mechas from mined parts and
          fight back!
        </p>
        <button class="btn btn-large" onclick="startGame()">
          Start Mining
        </button>
      </div>

      <!-- Mine Selection Screen -->
      <div id="mine-selection-screen" class="screen">
        <h1>üåå Asteroid Mining Colony üåå</h1>
        <p>
          Select a mining location to begin operations. Each mine produces
          different resources and houses unique mechas!
        </p>

        <div class="mine-map">
          <div class="mine-location" id="mine-1" onclick="selectMine(1)">
            <div class="mine-name">ü™® Rock Mine</div>
            <div class="mine-cost">FREE - Start Here!</div>
            <div class="mine-preview">
              <div class="mecha-preview">
                <img
                  src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='25' y='25' width='50' height='50' fill='%2327ae60' rx='10'/><circle cx='40' cy='40' r='5' fill='%23fff'/><circle cx='60' cy='40' r='5' fill='%23fff'/></svg>"
                  alt="Green Mecha"
                />
                <div>Green Mecha</div>
              </div>
              <div style="font-size: 24px">VS</div>
              <div class="monster-preview">
                <img
                  src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><ellipse cx='50' cy='60' rx='35' ry='25' fill='%23f1c40f'/><circle cx='40' cy='50' r='4' fill='%23000'/><circle cx='60' cy='50' r='4' fill='%23000'/></svg>"
                  alt="Yellow Slime"
                />
                <div>Yellow Slime</div>
              </div>
            </div>
            <div>Produces: üêö Shells</div>
          </div>

          <div class="mine-location locked" id="mine-2">
            <div class="mine-name">‚ùÑÔ∏è Ice Mine</div>
            <div class="mine-cost">Cost: 20 Monster Shells</div>
            <div class="mine-preview">
              <div class="mecha-preview">
                <img
                  src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='25' y='25' width='50' height='50' fill='%23f1c40f' rx='10'/><circle cx='40' cy='40' r='5' fill='%23000'/><circle cx='60' cy='40' r='5' fill='%23000'/></svg>"
                  alt="Yellow Mecha"
                />
                <div>Yellow Mecha</div>
              </div>
              <div style="font-size: 24px">VS</div>
              <div class="monster-preview">
                <img
                  src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><ellipse cx='50' cy='60' rx='35' ry='25' fill='%2317a2b8'/><circle cx='40' cy='50' r='4' fill='%23fff'/><circle cx='60' cy='50' r='4' fill='%23fff'/></svg>"
                  alt="Teal Slime"
                />
                <div>Teal Slime</div>
              </div>
            </div>
            <div>Produces: ü™ô Coins</div>
          </div>

          <div class="mine-location locked" id="mine-3">
            <div class="mine-name">üî• Lava Mine</div>
            <div class="mine-cost">Cost: 100 Monster Coins</div>
            <div class="mine-preview">
              <div class="mecha-preview">
                <img
                  src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='25' y='25' width='50' height='50' fill='%23e74c3c' rx='10'/><circle cx='40' cy='40' r='5' fill='%23fff'/><circle cx='60' cy='40' r='5' fill='%23fff'/></svg>"
                  alt="Red Mecha"
                />
                <div>Red Mecha</div>
              </div>
              <div style="font-size: 24px">VS</div>
              <div class="monster-preview">
                <img
                  src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><ellipse cx='50' cy='60' rx='35' ry='25' fill='%233498db'/><circle cx='40' cy='50' r='4' fill='%23fff'/><circle cx='60' cy='50' r='4' fill='%23fff'/></svg>"
                  alt="Blue Slime"
                />
                <div>Blue Slime</div>
              </div>
            </div>
            <div>Produces: ü•á Bars</div>
          </div>

          <div class="mine-location locked" id="mine-4">
            <div class="mine-name">üíé Crystal Mine</div>
            <div class="mine-cost">Cost: 500 Monster Bars</div>
            <div class="mine-preview">
              <div class="mecha-preview">
                <img
                  src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='25' y='25' width='50' height='50' fill='%233498db' rx='10'/><circle cx='40' cy='40' r='5' fill='%23fff'/><circle cx='60' cy='40' r='5' fill='%23fff'/></svg>"
                  alt="Blue Mecha"
                />
                <div>Blue Mecha</div>
              </div>
              <div style="font-size: 24px">VS</div>
              <div class="monster-preview">
                <img
                  src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><ellipse cx='50' cy='60' rx='35' ry='25' fill='%23e67e22'/><circle cx='40' cy='50' r='4' fill='%23000'/><circle cx='60' cy='50' r='4' fill='%23000'/></svg>"
                  alt="Orange Slime"
                />
                <div>Orange Slime</div>
              </div>
            </div>
            <div>Produces: üìú Bonds</div>
          </div>

          <div class="mine-location locked" id="mine-5">
            <div class="mine-name">üåü Plasma Mine</div>
            <div class="mine-cost">Cost: 2000 Monster Bonds</div>
            <div class="mine-preview">
              <div class="mecha-preview">
                <img
                  src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='25' y='25' width='50' height='50' fill='%23e91e63' rx='10'/><circle cx='40' cy='40' r='5' fill='%23fff'/><circle cx='60' cy='40' r='5' fill='%23fff'/></svg>"
                  alt="Pink Mecha"
                />
                <div>Pink Mecha</div>
              </div>
              <div style="font-size: 24px">VS</div>
              <div class="monster-preview">
                <img
                  src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><ellipse cx='50' cy='60' rx='35' ry='25' fill='%23000'/><circle cx='40' cy='50' r='4' fill='%23fff'/><circle cx='60' cy='50' r='4' fill='%23fff'/></svg>"
                  alt="Black Slime"
                />
                <div>Black Slime</div>
              </div>
            </div>
            <div>Produces: üíé Gems</div>
          </div>
        </div>

        <div class="trading-post">
          <h3>ü§ñ AstroGuide Trading Post</h3>
          <p>
            Need to exchange currencies? I can help, but my rates aren't great!
          </p>
          <div class="exchange-rates" id="exchange-rates">
            <!-- Dynamic exchange options will be populated here -->
          </div>
        </div>
      </div>

      <!-- Mining Screen -->
      <div id="mining-screen" class="screen">
        <h2 id="mine-title">ü™® Rock Mine Operations</h2>

        <div class="mining-interface">
          <div class="mining-area">
            <h3>Mining Operations</h3>

            <!-- Main Mining Machine -->
            <div
              class="mining-machine"
              id="main-mining-machine"
              onclick="interactMiningMachine()"
            >
              <div class="machine-status">
                <h4>Primary Excavator</h4>
                <div class="progress-bar">
                  <div class="progress-fill" id="mining-progress"></div>
                </div>
                <div class="currency-display">
                  <span>Ready to Collect:</span>
                  <span class="currency-amount" id="pending-currency"
                    >0 üêö</span
                  >
                </div>
                <div class="currency-display">
                  <span>Geodes Ready:</span>
                  <span class="currency-amount" id="pending-geodes">0 üì¶</span>
                </div>
                <button
                  class="btn"
                  id="collect-btn"
                  onclick="collectResources()"
                  disabled
                >
                  Collect Resources
                </button>
              </div>
            </div>

            <!-- Additional Mining Machines -->
            <div class="mining-machine locked" id="mining-machine-2">
              <div class="machine-status">
                <h4>Secondary Excavator</h4>
                <div class="mine-cost">Cost: 25 üêö + 0 Monster Shells</div>
                <button class="btn" onclick="buyMiningMachine(2)">
                  Purchase Machine
                </button>
              </div>
            </div>

            <div class="mining-machine locked" id="mining-machine-3">
              <div class="machine-status">
                <h4>Advanced Excavator</h4>
                <div class="mine-cost">Cost: 50 üêö + 1 Monster Shell</div>
                <button class="btn" onclick="buyMiningMachine(3)">
                  Purchase Machine
                </button>
              </div>
            </div>

            <div class="mining-machine locked" id="mining-machine-4">
              <div class="machine-status">
                <h4>Quantum Excavator</h4>
                <div class="mine-cost">Cost: 500 üêö + 10 Monster Shells</div>
                <button class="btn" onclick="buyMiningMachine(4)">
                  Purchase Machine
                </button>
              </div>
            </div>

            <!-- Currency Display -->
            <div class="currency-display">
              <span>Total üêö Shells:</span>
              <span class="currency-amount" id="total-currency">0</span>
            </div>
            <div class="currency-display">
              <span>Monster Shells:</span>
              <span class="currency-amount" id="monster-currency">0</span>
            </div>

            <!-- Upgrades -->
            <button class="btn" onclick="openUpgrades()">
              üé∞ Spin for Upgrades
            </button>
          </div>

          <div class="mecha-building">
            <h3>Mecha Assembly</h3>

            <div class="mecha-display">
              <img
                src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='25' y='25' width='50' height='50' fill='%2327ae60' rx='10'/><circle cx='40' cy='40' r='5' fill='%23fff'/><circle cx='60' cy='40' r='5' fill='%23fff'/></svg>"
                alt="Green Mecha"
                class="mecha-image"
                id="mecha-image"
              />
              <div id="mecha-multiplier">Production Bonus: x1</div>
            </div>

            <div class="parts-grid">
              <div class="part-slot" id="part-head">
                <span>ü§ñ</span>
                <div class="part-name">Head</div>
              </div>
              <div class="part-slot" id="part-left-arm">
                <span>üí™</span>
                <div class="part-name">Left Arm</div>
              </div>
              <div class="part-slot" id="part-right-arm">
                <span>üí™</span>
                <div class="part-name">Right Arm</div>
              </div>
              <div class="part-slot" id="part-torso">
                <span>üõ°Ô∏è</span>
                <div class="part-name">Torso</div>
              </div>
              <div class="part-slot" id="part-left-leg">
                <span>ü¶µ</span>
                <div class="part-name">Left Leg</div>
              </div>
              <div class="part-slot" id="part-right-leg">
                <span>ü¶µ</span>
                <div class="part-name">Right Leg</div>
              </div>
            </div>

            <button
              class="btn build-mecha-btn"
              id="build-mecha-btn"
              onclick="buildMecha()"
              disabled
            >
              Build Mecha (Need All Parts)
            </button>

            <div class="combat-ready" id="combat-ready" style="display: none">
              <h4>üö® Combat Ready! üö®</h4>
              <div class="monster-info">
                <div>
                  <img
                    src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><ellipse cx='50' cy='60' rx='35' ry='25' fill='%23f1c40f'/><circle cx='40' cy='50' r='4' fill='%23000'/><circle cx='60' cy='50' r='4' fill='%23000'/></svg>"
                    alt="Yellow Slime"
                    class="monster-image"
                  />
                  <div>Yellow Slime</div>
                  <div>Threat Level: Low</div>
                </div>
                <button class="btn" onclick="startCombat()">
                  ‚öîÔ∏è Fight Monster
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="game-log" id="mining-log">
          <div class="log-entry">
            ü§ñ AstroGuide: Welcome to the Rock Mine! Click the mining machine to
            start operations.
          </div>
          <div class="log-entry">
            ü§ñ AstroGuide: Collect resources and build mecha parts to defend our
            colony!
          </div>
        </div>

        <button class="btn" onclick="returnToMineSelection()">
          ‚Üê Back to Mine Selection
        </button>
      </div>

      <!-- Combat Screen -->
      <div id="combat-screen" class="screen">
        <h2>‚öîÔ∏è Mecha Combat</h2>

        <div class="battle-arena">
          <div class="fighter-card">
            <h3 id="mecha-name">Green Mecha</h3>
            <img
              src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='25' y='25' width='50' height='50' fill='%2327ae60' rx='10'/><circle cx='40' cy='40' r='5' fill='%23fff'/><circle cx='60' cy='40' r='5' fill='%23fff'/></svg>"
              alt="Mecha"
              class="fighter-sprite"
              id="mecha-sprite"
            />
            <div class="stats">
              <div>
                HP: <span id="mecha-hp">100</span> /
                <span id="mecha-max-hp">100</span>
              </div>
              <div class="stat-bar">
                <div
                  class="stat-fill hp-fill"
                  id="mecha-hp-bar"
                  style="width: 100%"
                ></div>
              </div>
              <div>
                Energy: <span id="mecha-energy">12</span> /
                <span id="mecha-max-energy">12</span>
              </div>
              <div class="stat-bar">
                <div
                  class="stat-fill energy-fill"
                  id="mecha-energy-bar"
                  style="width: 100%"
                ></div>
              </div>
            </div>
          </div>

          <div class="fighter-card">
            <h3 id="monster-name">Yellow Slime</h3>
            <img
              src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><ellipse cx='50' cy='60' rx='35' ry='25' fill='%23f1c40f'/><circle cx='40' cy='50' r='4' fill='%23000'/><circle cx='60' cy='50' r='4' fill='%23000'/></svg>"
              alt="Monster"
              class="fighter-sprite"
              id="monster-sprite"
            />
            <div class="stats">
              <div>
                HP: <span id="monster-hp">80</span> /
                <span id="monster-max-hp">80</span>
              </div>
              <div class="stat-bar">
                <div
                  class="stat-fill hp-fill"
                  id="monster-hp-bar"
                  style="width: 100%"
                ></div>
              </div>
              <div>
                Energy: <span id="monster-energy">10</span> /
                <span id="monster-max-energy">10</span>
              </div>
              <div class="stat-bar">
                <div
                  class="stat-fill energy-fill"
                  id="monster-energy-bar"
                  style="width: 100%"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <div class="move-buttons">
          <button
            class="move-btn"
            id="light-attack-btn"
            onclick="mechaMove('light')"
          >
            <img
              src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 10 L60 40 L90 40 L70 60 L80 90 L50 70 L20 90 L30 60 L10 40 L40 40 Z' fill='%23f1c40f'/></svg>"
              alt="Light Attack"
              class="move-icon"
            />
            <span>Light Attack</span>
            <small>Cost: 2 Energy</small>
          </button>
          <button
            class="move-btn"
            id="heavy-attack-btn"
            onclick="mechaMove('heavy')"
          >
            <img
              src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23e74c3c'/><circle cx='50' cy='50' r='20' fill='%23fff'/></svg>"
              alt="Heavy Attack"
              class="move-icon"
            />
            <span>Heavy Attack</span>
            <small>Cost: 4 Energy</small>
          </button>
          <button
            class="move-btn"
            id="defend-btn"
            onclick="mechaMove('defend')"
          >
            <img
              src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 10 L80 30 L80 70 L50 90 L20 70 L20 30 Z' fill='%233498db'/></svg>"
              alt="Defend"
              class="move-icon"
            />
            <span>Defend</span>
            <small>Cost: 1 Energy</small>
          </button>
          <button class="move-btn" id="rest-btn" onclick="mechaMove('rest')">
            <img
              src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%2327ae60'/><path d='M30 50 L50 30 L70 50 L50 70 Z' fill='%23fff'/></svg>"
              alt="Rest"
              class="move-icon"
            />
            <span>Rest</span>
            <small>Cost: 0 Energy</small>
          </button>
        </div>

        <div class="game-log" id="combat-log">
          <div class="log-entry combat">
            ‚öîÔ∏è Combat begins! Your Green Mecha faces the Yellow Slime!
          </div>
        </div>

        <button class="btn" onclick="returnToMining()">
          ‚Üê Return to Mining
        </button>
      </div>

      <!-- Training Screen -->
      <div id="training-screen" class="screen">
        <h2>üéØ Mecha Training</h2>
        <p>Click the bubbles quickly to earn training currency!</p>

        <div class="training-area">
          <div style="text-align: center; margin-bottom: 20px">
            <div>
              Time: <span id="training-time">15</span>s | Score:
              <span id="training-score">0</span> | Combo:
              <span id="training-combo">0</span>
            </div>
          </div>

          <div class="bubble-clicker" id="bubble-area">
            <!-- Bubbles will be spawned here dynamically -->
          </div>

          <div id="training-complete" style="display: none">
            <h3>Training Complete!</h3>
            <p>Final Score: <span id="final-training-score">0</span></p>

            <div class="slots-container">
              <h4>üé∞ Training Upgrades</h4>
              <p>
                Spend training currency on upgrades or try your luck with slots!
              </p>

              <div class="slots-reels">
                <div class="slot-reel" id="slot-1">‚ùì</div>
                <div class="slot-reel" id="slot-2">‚ùì</div>
                <div class="slot-reel" id="slot-3">‚ùì</div>
              </div>

              <button class="btn" onclick="spinTrainingSlots()">
                üé∞ Spin Slots (Cost: <span id="slot-cost">10</span>)
              </button>
              <div
                id="slot-result"
                style="margin: 10px 0; font-weight: bold"
              ></div>
            </div>

            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin: 20px 0;
              "
            >
              <button class="btn" onclick="buyTrainingUpgrade('attack')">
                +5 Attack (Cost: <span id="attack-cost">50</span>)
              </button>
              <button class="btn" onclick="buyTrainingUpgrade('defense')">
                +5 Defense (Cost: <span id="defense-cost">50</span>)
              </button>
              <button class="btn" onclick="buyTrainingUpgrade('hp')">
                +25 HP (Cost: <span id="hp-cost">75</span>)
              </button>
              <button class="btn" onclick="buyTrainingUpgrade('energy')">
                +2 Energy (Cost: <span id="energy-cost">40</span>)
              </button>
            </div>

            <button class="btn" onclick="continueAfterTraining()">
              Continue to Next Battle
            </button>
          </div>
        </div>
      </div>

      <!-- Upgrades Screen -->
      <div id="upgrades-screen" class="screen">
        <h2>üé∞ Mine Upgrades</h2>
        <p>Spin the wheel to get random upgrades for your mining operation!</p>

        <div class="slots-container">
          <div class="slots-reels">
            <div class="slot-reel" id="upgrade-slot-1">‚ùì</div>
            <div class="slot-reel" id="upgrade-slot-2">‚ùì</div>
            <div class="slot-reel" id="upgrade-slot-3">‚ùì</div>
          </div>

          <button class="btn" onclick="spinUpgradeSlots()">
            üé∞ Spin for Upgrade (Cost: <span id="upgrade-cost">25</span> üêö)
          </button>
          <div
            id="upgrade-result"
            style="margin: 20px 0; font-weight: bold"
          ></div>
        </div>

        <div class="game-log" id="upgrades-log">
          <div class="log-entry">
            üé∞ Try your luck! Each upgrade increases the cost of the next spin.
          </div>
        </div>

        <button class="btn" onclick="returnToMining()">‚Üê Back to Mining</button>
      </div>

      <!-- Final Boss Screen -->
      <div id="final-boss-screen" class="screen">
        <h1>üèÜ FINAL CHALLENGE üèÜ</h1>
        <p>
          You've defeated all the mine bosses! Now face the ultimate enemy - the
          Slime King!
        </p>

        <div class="battle-arena">
          <div class="fighter-card">
            <h3>Ultimate Mecha</h3>
            <img
              src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='20' width='60' height='60' fill='%23f39c12' rx='10'/><circle cx='35' cy='35' r='5' fill='%23fff'/><circle cx='65' cy='35' r='5' fill='%23fff'/><rect x='40' y='50' width='20' height='10' fill='%23e74c3c'/></svg>"
              alt="Ultimate Mecha"
              class="fighter-sprite"
            />
          </div>
          <div class="fighter-card">
            <h3>üëë Slime King üëë</h3>
            <img
              src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><ellipse cx='50' cy='65' rx='45' ry='30' fill='%23000'/><circle cx='35' cy='50' r='6' fill='%23ff0'/><circle cx='65' cy='50' r='6' fill='%23ff0'/><path d='M30 30 L50 20 L70 30 L60 40 L40 40 Z' fill='%23f1c40f'/></svg>"
              alt="Slime King"
              class="fighter-sprite"
            />
          </div>
        </div>

        <button class="btn btn-large" onclick="startFinalBoss()">
          ‚öîÔ∏è Begin Final Battle
        </button>
      </div>

      <!-- Victory Screen -->
      <div id="victory-screen" class="screen">
        <h1>üéâ VICTORY! üéâ</h1>
        <p>
          Congratulations! You have successfully stopped the evil slimes and
          restored the asteroid mining colony!
        </p>
        <p>
          The colony is safe thanks to your brave mechas and strategic mining
          operations.
        </p>

        <div style="text-align: center; margin: 30px 0">
          <div style="font-size: 48px; margin: 20px 0">üèÜü§ñüèÜ</div>
          <h2>You are the champion of the asteroid!</h2>
        </div>

        <button class="btn btn-large" onclick="startGame()">
          üîÑ Play Again
        </button>
      </div>
    </div>

    <script>
      // Game State Management
      const gameState = {
        currentMine: 1,
        currentBattle: 1,
        currencies: {
          shells: 0,
          coins: 0,
          bars: 0,
          bonds: 0,
          gems: 0,
          monsterShells: 0,
          monsterCoins: 0,
          monsterBars: 0,
          monsterBonds: 0,
          monsterGems: 0,
        },
        mechas: {
          1: {
            built: 0,
            parts: {
              head: false,
              leftArm: false,
              rightArm: false,
              torso: false,
              leftLeg: false,
              rightLeg: false,
            },
          },
          2: {
            built: 0,
            parts: {
              head: false,
              leftArm: false,
              rightArm: false,
              torso: false,
              leftLeg: false,
              rightLeg: false,
            },
          },
          3: {
            built: 0,
            parts: {
              head: false,
              leftArm: false,
              rightArm: false,
              torso: false,
              leftLeg: false,
              rightLeg: false,
            },
          },
          4: {
            built: 0,
            parts: {
              head: false,
              leftArm: false,
              rightArm: false,
              torso: false,
              leftLeg: false,
              rightLeg: false,
            },
          },
          5: {
            built: 0,
            parts: {
              head: false,
              leftArm: false,
              rightArm: false,
              torso: false,
              leftLeg: false,
              rightLeg: false,
            },
          },
        },
        mining: {
          1: {
            active: false,
            progress: 0,
            collected: 0,
            geodes: 0,
            machines: 1,
            upgradeLevel: 0,
            upgradeCost: 25,
          },
          2: {
            active: false,
            progress: 0,
            collected: 0,
            geodes: 0,
            machines: 0,
            upgradeLevel: 0,
            upgradeCost: 25,
          },
          3: {
            active: false,
            progress: 0,
            collected: 0,
            geodes: 0,
            machines: 0,
            upgradeLevel: 0,
            upgradeCost: 25,
          },
          4: {
            active: false,
            progress: 0,
            collected: 0,
            geodes: 0,
            machines: 0,
            upgradeLevel: 0,
            upgradeCost: 25,
          },
          5: {
            active: false,
            progress: 0,
            collected: 0,
            geodes: 0,
            machines: 0,
            upgradeLevel: 0,
            upgradeCost: 25,
          },
        },
        unlockedMines: [1],
        defeatedBosses: [],
        combat: {
          active: false,
          mechaStats: {
            hp: 100,
            maxHp: 100,
            energy: 12,
            maxEnergy: 12,
            attack: 15,
            defense: 8,
          },
          monsterStats: {
            hp: 80,
            maxHp: 80,
            energy: 10,
            maxEnergy: 10,
            attack: 12,
            defense: 5,
          },
          turn: "player",
          battlePhase: 1,
        },
        training: {
          active: false,
          score: 0,
          combo: 0,
          timeLeft: 15,
          currency: 0,
          upgradeCosts: { attack: 50, defense: 50, hp: 75, energy: 40 },
          slotCost: 10,
        },
      };

      // Mine Configuration
      const mineConfig = {
        1: {
          name: "Rock Mine",
          currency: "shells",
          mecha: "Green",
          monster: "Yellow Slime",
          unlockCost: 0,
          icon: "ü™®",
        },
        2: {
          name: "Ice Mine",
          currency: "coins",
          mecha: "Yellow",
          monster: "Teal Slime",
          unlockCost: 20,
          icon: "‚ùÑÔ∏è",
        },
        3: {
          name: "Lava Mine",
          currency: "bars",
          mecha: "Red",
          monster: "Blue Slime",
          unlockCost: 100,
          icon: "üî•",
        },
        4: {
          name: "Crystal Mine",
          currency: "bonds",
          mecha: "Blue",
          monster: "Orange Slime",
          unlockCost: 500,
          icon: "üíé",
        },
        5: {
          name: "Plasma Mine",
          currency: "gems",
          mecha: "Pink",
          monster: "Black Slime",
          unlockCost: 2000,
          icon: "üåü",
        },
      };

      // Game Flow Functions
      function startGame() {
        showScreen("mine-selection-screen");
        updateMineSelection();
        logMessage(
          "ü§ñ AstroGuide: Welcome to the asteroid mining colony! Choose your first mining location."
        );
      }

      function showScreen(screenId) {
        document
          .querySelectorAll(".screen")
          .forEach((screen) => screen.classList.remove("active"));
        document.getElementById(screenId).classList.add("active");
      }

      function selectMine(mineId) {
        if (!gameState.unlockedMines.includes(mineId)) {
          const config = mineConfig[mineId];
          const cost = config.unlockCost;
          const requiredCurrency =
            mineId === 2
              ? "monsterShells"
              : mineId === 3
              ? "monsterCoins"
              : mineId === 4
              ? "monsterBars"
              : mineId === 5
              ? "monsterBonds"
              : "";

          if (gameState.currencies[requiredCurrency] >= cost) {
            gameState.currencies[requiredCurrency] -= cost;
            gameState.unlockedMines.push(mineId);
            logMessage(
              `üéâ Unlocked ${config.name}! Cost: ${cost} ${requiredCurrency}`
            );
            updateMineSelection();
          } else {
            logMessage(
              `‚ùå Need ${cost} ${requiredCurrency} to unlock ${config.name}`
            );
          }
          return;
        }

        gameState.currentMine = mineId;
        showScreen("mining-screen");
        setupMiningScreen();
      }

      function setupMiningScreen() {
        const config = mineConfig[gameState.currentMine];
        document.getElementById(
          "mine-title"
        ).textContent = `${config.icon} ${config.name} Operations`;

        // Update currency displays
        updateCurrencyDisplays();
        updateMechaBuilding();

        // Start mining if not already active
        if (!gameState.mining[gameState.currentMine].active) {
          startMining();
        }

        logMessage(
          `ü§ñ AstroGuide: Welcome to ${config.name}! Mining operations ready.`
        );
      }

      function updateMineSelection() {
        // Update mine lock status
        for (let i = 1; i <= 5; i++) {
          const mineElement = document.getElementById(`mine-${i}`);
          if (gameState.unlockedMines.includes(i)) {
            mineElement.classList.remove("locked");
          } else {
            mineElement.classList.add("locked");
          }
        }

        // Update trading post
        updateTradingPost();
      }

      function updateTradingPost() {
        const exchangeRates = document.getElementById("exchange-rates");
        let html = "";

        // Only show exchange options for currencies we have
        const availableCurrencies = Object.keys(gameState.currencies).filter(
          (key) => gameState.currencies[key] > 0
        );

        availableCurrencies.forEach((currency) => {
          const amount = gameState.currencies[currency];
          html += `
                    <div class="exchange-option" onclick="showExchangeOptions('${currency}')">
                        <div>${getCurrencyIcon(currency)} ${amount}</div>
                        <div>Click to Exchange</div>
                    </div>
                `;
        });

        if (html === "") {
          html =
            '<div class="exchange-option">No currencies available for exchange</div>';
        }

        exchangeRates.innerHTML = html;
      }

      function getCurrencyIcon(currency) {
        const icons = {
          shells: "üêö",
          coins: "ü™ô",
          bars: "ü•á",
          bonds: "üìú",
          gems: "üíé",
          monsterShells: "üêöüëπ",
          monsterCoins: "ü™ôüëπ",
          monsterBars: "ü•áüëπ",
          monsterBonds: "üìúüëπ",
          monsterGems: "üíéüëπ",
        };
        return icons[currency] || "‚ùì";
      }

      // Mining Functions
      function startMining() {
        const mineData = gameState.mining[gameState.currentMine];
        if (mineData.active) return;

        mineData.active = true;
        mineData.progress = 0;

        // Mining loop - fills every 10 seconds initially
        const miningInterval = setInterval(() => {
          if (!mineData.active) {
            clearInterval(miningInterval);
            return;
          }

          mineData.progress += 10;
          if (mineData.progress >= 100) {
            mineData.progress = 0;
            const baseProduction =
              1 * (gameState.mechas[gameState.currentMine].built + 1);
            mineData.collected += baseProduction;
            mineData.geodes += 1;

            logMessage(
              `‚õèÔ∏è Mining complete! Collected ${baseProduction} resources and 1 geode.`
            );
          }

          updateMiningDisplay();
        }, 1000);

        logMessage("‚õèÔ∏è Mining started! Operations running automatically.");
      }

      function updateMiningDisplay() {
        const mineData = gameState.mining[gameState.currentMine];
        const config = mineConfig[gameState.currentMine];

        document.getElementById("mining-progress").style.width =
          mineData.progress + "%";
        document.getElementById("pending-currency").textContent = `${
          mineData.collected
        } ${getCurrencyIcon(config.currency)}`;
        document.getElementById(
          "pending-geodes"
        ).textContent = `${mineData.geodes} üì¶`;

        document.getElementById("collect-btn").disabled =
          mineData.collected === 0 && mineData.geodes === 0;
      }

      function interactMiningMachine() {
        if (
          gameState.mining[gameState.currentMine].collected > 0 ||
          gameState.mining[gameState.currentMine].geodes > 0
        ) {
          collectResources();
        } else {
          logMessage(
            "ü§ñ AstroGuide: The mining machine is working! Wait for resources to be ready for collection."
          );
        }
      }

      function collectResources() {
        const mineData = gameState.mining[gameState.currentMine];
        const config = mineConfig[gameState.currentMine];

        if (mineData.collected > 0) {
          gameState.currencies[config.currency] += mineData.collected;
          logMessage(
            `‚úÖ Collected ${mineData.collected} ${getCurrencyIcon(
              config.currency
            )}!`
          );
          mineData.collected = 0;
        }

        if (mineData.geodes > 0) {
          openGeodes(mineData.geodes);
          mineData.geodes = 0;
        }

        updateCurrencyDisplays();
        updateMiningDisplay();
      }

      function openGeodes(count) {
        let partsFound = 0;
        let bonusCurrency = 0;

        for (let i = 0; i < count; i++) {
          if (Math.random() < 0.05) {
            // 5% chance for mecha part
            const partTypes = [
              "head",
              "leftArm",
              "rightArm",
              "torso",
              "leftLeg",
              "rightLeg",
            ];
            const randomPart =
              partTypes[Math.floor(Math.random() * partTypes.length)];

            if (!gameState.mechas[gameState.currentMine].parts[randomPart]) {
              gameState.mechas[gameState.currentMine].parts[randomPart] = true;
              partsFound++;
              logMessage(`üéâ Found mecha part: ${randomPart}!`, "success");
            } else {
              // Already have this part, give bonus currency instead
              bonusCurrency += Math.floor(Math.random() * 10) + 5;
            }
          } else {
            // 95% chance for bonus currency
            bonusCurrency += Math.floor(Math.random() * 20) + 1;
          }
        }

        if (bonusCurrency > 0) {
          const config = mineConfig[gameState.currentMine];
          gameState.currencies[config.currency] += bonusCurrency;
          logMessage(
            `üí∞ Bonus currency from geodes: ${bonusCurrency} ${getCurrencyIcon(
              config.currency
            )}`
          );
        }

        if (partsFound > 0) {
          updateMechaBuilding();
        }
      }

      function updateCurrencyDisplays() {
        const config = mineConfig[gameState.currentMine];
        document.getElementById("total-currency").textContent =
          gameState.currencies[config.currency];

        const monsterCurrencyKey =
          "monster" +
          config.currency.charAt(0).toUpperCase() +
          config.currency.slice(1);
        document.getElementById("monster-currency").textContent =
          gameState.currencies[monsterCurrencyKey] || 0;
      }

      function updateMechaBuilding() {
        const mechaData = gameState.mechas[gameState.currentMine];
        const parts = mechaData.parts;

        // Update part slots
        Object.keys(parts).forEach((partType) => {
          const slot = document.getElementById(
            `part-${partType.replace(/([A-Z])/g, "-$1").toLowerCase()}`
          );
          if (slot) {
            if (parts[partType]) {
              slot.classList.add("filled");
              slot.style.background = "rgba(46, 204, 113, 0.3)";
            } else {
              slot.classList.remove("filled");
              slot.style.background = "rgba(0, 0, 0, 0.3)";
            }
          }
        });

        // Check if all parts are collected
        const allPartsCollected = Object.values(parts).every(
          (hasPart) => hasPart
        );
        const buildBtn = document.getElementById("build-mecha-btn");

        if (allPartsCollected) {
          buildBtn.disabled = false;
          buildBtn.textContent = "Build Mecha (All Parts Ready!)";
          buildBtn.style.background = "var(--mecha-gradient)";
        } else {
          buildBtn.disabled = true;
          const missingParts = Object.keys(parts).filter(
            (part) => !parts[part]
          ).length;
          buildBtn.textContent = `Build Mecha (Need ${missingParts} more parts)`;
          buildBtn.style.background = "var(--background-overlay)";
        }

        // Update production multiplier display
        const multiplier = mechaData.built + 1;
        document.getElementById(
          "mecha-multiplier"
        ).textContent = `Production Bonus: x${multiplier}`;

        // Show combat ready if we have mechas
        const combatReady = document.getElementById("combat-ready");
        if (mechaData.built > 0) {
          combatReady.style.display = "block";
        } else {
          combatReady.style.display = "none";
        }
      }

      function buildMecha() {
        const mechaData = gameState.mechas[gameState.currentMine];
        const parts = mechaData.parts;

        // Check if all parts are available
        const allPartsCollected = Object.values(parts).every(
          (hasPart) => hasPart
        );
        if (!allPartsCollected) {
          logMessage("‚ùå Cannot build mecha - missing parts!");
          return;
        }

        // Consume parts and build mecha
        Object.keys(parts).forEach((part) => (parts[part] = false));
        mechaData.built++;

        const config = mineConfig[gameState.currentMine];
        logMessage(
          `ü§ñ ${config.mecha} Mecha built! Production bonus increased to x${
            mechaData.built + 1
          }`,
          "success"
        );

        updateMechaBuilding();
        updateCurrencyDisplays();
      }

      function buyMiningMachine(machineId) {
        const mineData = gameState.mining[gameState.currentMine];
        const config = mineConfig[gameState.currentMine];

        const costs = {
          2: { currency: 25, monster: 0 },
          3: { currency: 50, monster: 1 },
          4: { currency: 500, monster: 10 },
        };

        const cost = costs[machineId];
        const currencyKey = config.currency;
        const monsterCurrencyKey =
          "monster" +
          currencyKey.charAt(0).toUpperCase() +
          currencyKey.slice(1);

        if (
          gameState.currencies[currencyKey] >= cost.currency &&
          gameState.currencies[monsterCurrencyKey] >= cost.monster
        ) {
          gameState.currencies[currencyKey] -= cost.currency;
          gameState.currencies[monsterCurrencyKey] -= cost.monster;
          mineData.machines++;

          logMessage(
            `‚õèÔ∏è Purchased mining machine ${machineId}! Production increased.`,
            "success"
          );

          // Hide the purchase button and show active machine
          const machineElement = document.getElementById(
            `mining-machine-${machineId}`
          );
          machineElement.classList.remove("locked");
          machineElement.innerHTML = `
                    <div class="machine-status">
                        <h4>Excavator ${machineId}</h4>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${
                              Math.random() * 100
                            }%"></div>
                        </div>
                        <div>Status: Active</div>
                    </div>
                `;

          updateCurrencyDisplays();
        } else {
          logMessage(
            `‚ùå Not enough resources! Need ${cost.currency} ${getCurrencyIcon(
              currencyKey
            )} and ${cost.monster} ${getCurrencyIcon(monsterCurrencyKey)}`
          );
        }
      }

      // Combat Functions
      function startCombat() {
        gameState.combat.active = true;
        gameState.combat.battlePhase = 1;

        // Reset combat stats
        const config = mineConfig[gameState.currentMine];
        gameState.combat.mechaStats = {
          hp: 100 + gameState.mechas[gameState.currentMine].built * 25,
          maxHp: 100 + gameState.mechas[gameState.currentMine].built * 25,
          energy: 12 + gameState.mechas[gameState.currentMine].built * 2,
          maxEnergy: 12 + gameState.mechas[gameState.currentMine].built * 2,
          attack: 15 + gameState.mechas[gameState.currentMine].built * 3,
          defense: 8 + gameState.mechas[gameState.currentMine].built * 2,
        };

        // Monster stats scale with mine level
        const monsterScaling = gameState.currentMine * 1.5;
        gameState.combat.monsterStats = {
          hp: Math.floor(80 * monsterScaling),
          maxHp: Math.floor(80 * monsterScaling),
          energy: Math.floor(10 * monsterScaling),
          maxEnergy: Math.floor(10 * monsterScaling),
          attack: Math.floor(12 * monsterScaling),
          defense: Math.floor(5 * monsterScaling),
        };

        showScreen("combat-screen");
        setupCombatScreen();
        logMessage(
          `‚öîÔ∏è Combat begins! ${config.mecha} Mecha vs ${config.monster}!`,
          "combat"
        );
      }

      function setupCombatScreen() {
        const config = mineConfig[gameState.currentMine];
        const mecha = gameState.combat.mechaStats;
        const monster = gameState.combat.monsterStats;

        // Update mecha display
        document.getElementById(
          "mecha-name"
        ).textContent = `${config.mecha} Mecha`;
        document.getElementById("mecha-hp").textContent = mecha.hp;
        document.getElementById("mecha-max-hp").textContent = mecha.maxHp;
        document.getElementById("mecha-energy").textContent = mecha.energy;
        document.getElementById("mecha-max-energy").textContent =
          mecha.maxEnergy;
        updateStatBar("mecha-hp-bar", mecha.hp, mecha.maxHp);
        updateStatBar("mecha-energy-bar", mecha.energy, mecha.maxEnergy);

        // Update monster display
        document.getElementById("monster-name").textContent = config.monster;
        document.getElementById("monster-hp").textContent = monster.hp;
        document.getElementById("monster-max-hp").textContent = monster.maxHp;
        document.getElementById("monster-energy").textContent = monster.energy;
        document.getElementById("monster-max-energy").textContent =
          monster.maxEnergy;
        updateStatBar("monster-hp-bar", monster.hp, monster.maxHp);
        updateStatBar("monster-energy-bar", monster.energy, monster.maxEnergy);

        gameState.combat.turn = "player";
        updateCombatUI();
      }

      function updateStatBar(barId, current, max) {
        const bar = document.getElementById(barId);
        const percentage = (current / max) * 100;
        bar.style.width = Math.max(0, percentage) + "%";
      }

      function updateCombatUI() {
        const mecha = gameState.combat.mechaStats;
        const isPlayerTurn = gameState.combat.turn === "player";

        // Update move buttons
        document.getElementById("light-attack-btn").disabled =
          !isPlayerTurn || mecha.energy < 2;
        document.getElementById("heavy-attack-btn").disabled =
          !isPlayerTurn || mecha.energy < 4;
        document.getElementById("defend-btn").disabled =
          !isPlayerTurn || mecha.energy < 1;
        document.getElementById("rest-btn").disabled = !isPlayerTurn;
      }

      function mechaMove(moveType) {
        if (gameState.combat.turn !== "player") return;

        const mecha = gameState.combat.mechaStats;
        const monster = gameState.combat.monsterStats;

        let energyCost = 0;
        let damage = 0;
        let healing = 0;
        let message = "";

        switch (moveType) {
          case "light":
            energyCost = 2;
            damage = mecha.attack + Math.floor(Math.random() * 10) + 15;
            message = `${
              mineConfig[gameState.currentMine].mecha
            } Mecha uses Light Attack!`;
            break;
          case "heavy":
            energyCost = 4;
            damage = mecha.attack + Math.floor(Math.random() * 20) + 25;
            message = `${
              mineConfig[gameState.currentMine].mecha
            } Mecha uses Heavy Attack!`;
            break;
          case "defend":
            energyCost = 1;
            mecha.defense += 5; // Temporary defense boost
            message = `${
              mineConfig[gameState.currentMine].mecha
            } Mecha defends! Defense increased.`;
            break;
          case "rest":
            energyCost = 0;
            healing = Math.floor(mecha.maxEnergy * 0.4);
            mecha.energy = Math.min(mecha.maxEnergy, mecha.energy + healing);
            message = `${
              mineConfig[gameState.currentMine].mecha
            } Mecha rests! Energy restored.`;
            break;
        }

        // Check energy cost
        if (mecha.energy < energyCost) {
          logMessage("‚ùå Not enough energy!", "combat");
          return;
        }

        // Apply energy cost
        mecha.energy -= energyCost;

        // Apply damage
        if (damage > 0) {
          const finalDamage = Math.max(1, damage - monster.defense);
          monster.hp = Math.max(0, monster.hp - finalDamage);
          message += ` Deals ${finalDamage} damage!`;
        }

        logMessage(message, "combat");

        // Update displays
        updateCombatStats();

        // Check for victory
        if (monster.hp <= 0) {
          winCombat();
          return;
        }

        // Switch to monster turn
        gameState.combat.turn = "monster";
        setTimeout(() => monsterTurn(), 1500);
      }

      function monsterTurn() {
        const mecha = gameState.combat.mechaStats;
        const monster = gameState.combat.monsterStats;

        // Simple AI - monster chooses random move
        const moves = ["light", "heavy", "defend", "rest"];
        const availableMoves = moves.filter((move) => {
          switch (move) {
            case "light":
              return monster.energy >= 2;
            case "heavy":
              return monster.energy >= 4;
            case "defend":
              return monster.energy >= 1;
            case "rest":
              return true;
            default:
              return false;
          }
        });

        if (availableMoves.length === 0) {
          // Monster must rest
          monster.energy = Math.min(
            monster.maxEnergy,
            monster.energy + Math.floor(monster.maxEnergy * 0.4)
          );
          logMessage(
            `${
              mineConfig[gameState.currentMine].monster
            } rests! Energy restored.`,
            "combat"
          );
        } else {
          const chosenMove =
            availableMoves[Math.floor(Math.random() * availableMoves.length)];

          let energyCost = 0;
          let damage = 0;
          let message = `${mineConfig[gameState.currentMine].monster} `;

          switch (chosenMove) {
            case "light":
              energyCost = 2;
              damage = monster.attack + Math.floor(Math.random() * 8) + 10;
              message += "uses Slime Strike!";
              break;
            case "heavy":
              energyCost = 4;
              damage = monster.attack + Math.floor(Math.random() * 15) + 20;
              message += "uses Power Slime!";
              break;
            case "defend":
              energyCost = 1;
              monster.defense += 3;
              message += "hardens its slime! Defense increased.";
              break;
            case "rest":
              energyCost = 0;
              const healing = Math.floor(monster.maxEnergy * 0.3);
              monster.energy = Math.min(
                monster.maxEnergy,
                monster.energy + healing
              );
              message += "gathers slime energy! Energy restored.";
              break;
          }

          monster.energy -= energyCost;

          if (damage > 0) {
            const finalDamage = Math.max(1, damage - mecha.defense);
            mecha.hp = Math.max(0, mecha.hp - finalDamage);
            message += ` Deals ${finalDamage} damage!`;
          }

          logMessage(message, "combat");
        }

        updateCombatStats();

        // Check for defeat
        if (mecha.hp <= 0) {
          loseCombat();
          return;
        }

        // Return to player turn
        gameState.combat.turn = "player";
        updateCombatUI();
      }

      function updateCombatStats() {
        const mecha = gameState.combat.mechaStats;
        const monster = gameState.combat.monsterStats;

        // Update mecha stats
        document.getElementById("mecha-hp").textContent = mecha.hp;
        document.getElementById("mecha-energy").textContent = mecha.energy;
        updateStatBar("mecha-hp-bar", mecha.hp, mecha.maxHp);
        updateStatBar("mecha-energy-bar", mecha.energy, mecha.maxEnergy);

        // Update monster stats
        document.getElementById("monster-hp").textContent = monster.hp;
        document.getElementById("monster-energy").textContent = monster.energy;
        updateStatBar("monster-hp-bar", monster.hp, monster.maxHp);
        updateStatBar("monster-energy-bar", monster.energy, monster.maxEnergy);
      }

      function winCombat() {
        const config = mineConfig[gameState.currentMine];
        const baseReward = 20;
        const bonusReward = 50;
        const totalReward = baseReward + bonusReward;

        // Award monster currency
        const monsterCurrencyKey =
          "monster" +
          config.currency.charAt(0).toUpperCase() +
          config.currency.slice(1);
        gameState.currencies[monsterCurrencyKey] += totalReward;

        logMessage(
          `üéâ Victory! Earned ${totalReward} ${getCurrencyIcon(
            monsterCurrencyKey
          )}!`,
          "success"
        );

        // Mark boss as defeated
        if (!gameState.defeatedBosses.includes(gameState.currentMine)) {
          gameState.defeatedBosses.push(gameState.currentMine);
          logMessage(
            `üèÜ ${config.monster} defeated for the first time!`,
            "success"
          );
        }

        // Check if all bosses defeated
        if (gameState.defeatedBosses.length >= 5) {
          setTimeout(() => {
            showScreen("final-boss-screen");
          }, 2000);
          return;
        }

        // Proceed to training
        setTimeout(() => {
          showScreen("training-screen");
          startTraining();
        }, 2000);
      }

      function loseCombat() {
        const config = mineConfig[gameState.currentMine];
        const baseReward = 20;

        // Still get base reward but lose mecha
        const monsterCurrencyKey =
          "monster" +
          config.currency.charAt(0).toUpperCase() +
          config.currency.slice(1);
        gameState.currencies[monsterCurrencyKey] += baseReward;

        // Destroy one mecha
        if (gameState.mechas[gameState.currentMine].built > 0) {
          gameState.mechas[gameState.currentMine].built--;
          logMessage(
            `üí• ${
              config.mecha
            } Mecha destroyed! Earned ${baseReward} ${getCurrencyIcon(
              monsterCurrencyKey
            )}`,
            "combat"
          );
        }

        setTimeout(() => {
          showScreen("training-screen");
          startTraining();
        }, 2000);
      }

      // Training Functions
      function startTraining() {
        gameState.training.active = true;
        gameState.training.score = 0;
        gameState.training.combo = 0;
        gameState.training.timeLeft = 15;

        document.getElementById("training-complete").style.display = "none";
        document.getElementById("training-score").textContent = "0";
        document.getElementById("training-combo").textContent = "0";
        document.getElementById("training-time").textContent = "15";

        // Clear bubble area
        document.getElementById("bubble-area").innerHTML = "";

        // Start training timer
        const timer = setInterval(() => {
          gameState.training.timeLeft--;
          document.getElementById("training-time").textContent =
            gameState.training.timeLeft;

          if (gameState.training.timeLeft <= 0) {
            clearInterval(timer);
            endTraining();
          }
        }, 1000);

        // Start spawning bubbles
        spawnBubbles();

        logMessage(
          "üéØ Training started! Click the bubbles quickly!",
          "success"
        );
      }

      function spawnBubbles() {
        if (!gameState.training.active) return;

        const bubbleArea = document.getElementById("bubble-area");
        const maxBubbles = 6;
        const currentBubbles = bubbleArea.children.length;

        if (currentBubbles < maxBubbles && Math.random() < 0.7) {
          const bubble = document.createElement("div");
          bubble.className = "bubble";
          bubble.style.left =
            Math.random() * (bubbleArea.offsetWidth - 60) + "px";
          bubble.style.top =
            Math.random() * (bubbleArea.offsetHeight - 60) + "px";

          // Random bubble types
          const types = ["üéØ", "‚ö°", "üíé", "üî•", "‚ùÑÔ∏è"];
          const type = types[Math.floor(Math.random() * types.length)];
          bubble.textContent = type;

          const points =
            type === "üíé" ? 10 : type === "üî•" ? 5 : type === "‚ö°" ? 3 : 1;
          bubble.dataset.points = points;

          bubble.onclick = () => clickBubble(bubble);

          bubbleArea.appendChild(bubble);

          // Remove bubble after 3 seconds if not clicked
          setTimeout(() => {
            if (bubble.parentNode) {
              bubble.remove();
            }
          }, 3000);
        }

        // Continue spawning
        setTimeout(spawnBubbles, 500 + Math.random() * 1000);
      }

      function clickBubble(bubble) {
        const points = parseInt(bubble.dataset.points);
        gameState.training.combo++;
        const totalPoints = points * Math.min(gameState.training.combo, 10);
        gameState.training.score += totalPoints;

        document.getElementById("training-score").textContent =
          gameState.training.score;
        document.getElementById("training-combo").textContent =
          gameState.training.combo;

        // Visual feedback
        bubble.style.transform = "scale(1.5)";
        bubble.style.opacity = "0";
        setTimeout(() => bubble.remove(), 200);
      }

      function endTraining() {
        gameState.training.active = false;
        gameState.training.currency = gameState.training.score;

        document.getElementById("training-complete").style.display = "block";
        document.getElementById("final-training-score").textContent =
          gameState.training.score;

        updateTrainingUpgradeCosts();
        logMessage(
          `üéØ Training complete! Earned ${gameState.training.score} training currency.`,
          "success"
        );
      }

      function updateTrainingUpgradeCosts() {
        document.getElementById("attack-cost").textContent =
          gameState.training.upgradeCosts.attack;
        document.getElementById("defense-cost").textContent =
          gameState.training.upgradeCosts.defense;
        document.getElementById("hp-cost").textContent =
          gameState.training.upgradeCosts.hp;
        document.getElementById("energy-cost").textContent =
          gameState.training.upgradeCosts.energy;
        document.getElementById("slot-cost").textContent =
          gameState.training.slotCost;
      }

      function buyTrainingUpgrade(type) {
        const cost = gameState.training.upgradeCosts[type];

        if (gameState.training.currency >= cost) {
          gameState.training.currency -= cost;
          gameState.training.upgradeCosts[type] += 25; // Increase cost for next purchase

          // Apply upgrade to current mecha stats
          switch (type) {
            case "attack":
              gameState.combat.mechaStats.attack += 5;
              logMessage("‚öîÔ∏è Attack increased by 5!", "success");
              break;
            case "defense":
              gameState.combat.mechaStats.defense += 5;
              logMessage("üõ°Ô∏è Defense increased by 5!", "success");
              break;
            case "hp":
              gameState.combat.mechaStats.maxHp += 25;
              gameState.combat.mechaStats.hp += 25;
              logMessage("‚ù§Ô∏è HP increased by 25!", "success");
              break;
            case "energy":
              gameState.combat.mechaStats.maxEnergy += 2;
              gameState.combat.mechaStats.energy += 2;
              logMessage("‚ö° Energy increased by 2!", "success");
              break;
          }

          document.getElementById("final-training-score").textContent =
            gameState.training.currency;
          updateTrainingUpgradeCosts();
        } else {
          logMessage(`‚ùå Not enough training currency! Need ${cost}`, "combat");
        }
      }

      function spinTrainingSlots() {
        const cost = gameState.training.slotCost;

        if (gameState.training.currency >= cost) {
          gameState.training.currency -= cost;
          gameState.training.slotCost += 5;

          // Spin animation
          const slots = ["slot-1", "slot-2", "slot-3"];
          const symbols = ["üéØ", "‚öîÔ∏è", "üõ°Ô∏è", "‚ù§Ô∏è", "‚ö°", "üíé"];

          let spinCount = 0;
          const spinInterval = setInterval(() => {
            slots.forEach((slotId) => {
              document.getElementById(slotId).textContent =
                symbols[Math.floor(Math.random() * symbols.length)];
            });

            spinCount++;
            if (spinCount > 20) {
              clearInterval(spinInterval);
              resolveTrainingSlots();
            }
          }, 100);

          document.getElementById("final-training-score").textContent =
            gameState.training.currency;
          updateTrainingUpgradeCosts();
        } else {
          logMessage(`‚ùå Not enough training currency! Need ${cost}`, "combat");
        }
      }

      function resolveTrainingSlots() {
        const slot1 = document.getElementById("slot-1").textContent;
        const slot2 = document.getElementById("slot-2").textContent;
        const slot3 = document.getElementById("slot-3").textContent;

        const resultDiv = document.getElementById("slot-result");

        if (slot1 === slot2 && slot2 === slot3) {
          // Triple match!
          let reward = "";
          switch (slot1) {
            case "‚öîÔ∏è":
              gameState.combat.mechaStats.attack += 8;
              reward = "+8 Attack!";
              break;
            case "üõ°Ô∏è":
              gameState.combat.mechaStats.defense += 8;
              reward = "+8 Defense!";
              break;
            case "‚ù§Ô∏è":
              gameState.combat.mechaStats.maxHp += 40;
              gameState.combat.mechaStats.hp += 40;
              reward = "+40 HP!";
              break;
            case "‚ö°":
              gameState.combat.mechaStats.maxEnergy += 5;
              gameState.combat.mechaStats.energy += 5;
              reward = "+5 Energy!";
              break;
            case "üíé":
              gameState.training.currency += 100;
              reward = "+100 Training Currency!";
              break;
            default:
              gameState.training.currency += 50;
              reward = "+50 Training Currency!";
              break;
          }

          resultDiv.innerHTML = `<span style="color: #27ae60;">üéâ JACKPOT! ${reward}</span>`;
          logMessage(`üé∞ Slot machine jackpot! ${reward}`, "success");
        } else {
          resultDiv.innerHTML = `<span style="color: #95a5a6;">No match - try again!</span>`;
        }

        document.getElementById("final-training-score").textContent =
          gameState.training.currency;
      }

      function continueAfterTraining() {
        // Advance to next battle phase
        gameState.combat.battlePhase++;

        if (gameState.combat.battlePhase > 5) {
          // Completed all 5 battles for this mine
          logMessage("üèÜ All battles completed for this mine!", "success");
          showScreen("mining-screen");
          setupMiningScreen();
        } else {
          // Next battle
          logMessage(
            `‚öîÔ∏è Preparing for battle ${gameState.combat.battlePhase}/5`,
            "combat"
          );
          showScreen("combat-screen");
          setupCombatScreen();
        }
      }

      // Upgrade Functions
      function openUpgrades() {
        showScreen("upgrades-screen");
        updateUpgradeCost();
      }

      function updateUpgradeCost() {
        const cost = gameState.mining[gameState.currentMine].upgradeCost;
        document.getElementById("upgrade-cost").textContent = cost;
      }

      function spinUpgradeSlots() {
        const mineData = gameState.mining[gameState.currentMine];
        const config = mineConfig[gameState.currentMine];
        const cost = mineData.upgradeCost;

        if (gameState.currencies[config.currency] >= cost) {
          gameState.currencies[config.currency] -= cost;
          mineData.upgradeCost = Math.floor(mineData.upgradeCost * 1.5);

          // Spin animation
          const slots = ["upgrade-slot-1", "upgrade-slot-2", "upgrade-slot-3"];
          const symbols = ["‚ö°", "üí∞", "üîß", "üìà", "‚ùå"];

          let spinCount = 0;
          const spinInterval = setInterval(() => {
            slots.forEach((slotId) => {
              document.getElementById(slotId).textContent =
                symbols[Math.floor(Math.random() * symbols.length)];
            });

            spinCount++;
            if (spinCount > 15) {
              clearInterval(spinInterval);
              resolveUpgradeSlots();
            }
          }, 100);

          updateUpgradeCost();
          updateCurrencyDisplays();
        } else {
          logMessage(
            `‚ùå Not enough ${getCurrencyIcon(config.currency)}! Need ${cost}`,
            "combat"
          );
        }
      }

      function resolveUpgradeSlots() {
        const slot1 = document.getElementById("upgrade-slot-1").textContent;
        const slot2 = document.getElementById("upgrade-slot-2").textContent;
        const slot3 = document.getElementById("upgrade-slot-3").textContent;

        const resultDiv = document.getElementById("upgrade-result");
        const mineData = gameState.mining[gameState.currentMine];

        // Simple upgrade system
        if (slot1 === "‚ùå" && slot2 === "‚ùå" && slot3 === "‚ùå") {
          resultDiv.innerHTML = `<span style="color: #e74c3c;">Nothing happened!</span>`;
          logMessage("üí• Upgrade failed - nothing happened!", "combat");
        } else {
          // Count non-fail symbols
          const nonFailCount = [slot1, slot2, slot3].filter(
            (symbol) => symbol !== "‚ùå"
          ).length;

          if (nonFailCount >= 2) {
            // Success!
            const upgrades = [];

            if ([slot1, slot2, slot3].includes("‚ö°")) {
              mineData.upgradeLevel++;
              upgrades.push("Mining Speed +10%");
            }
            if ([slot1, slot2, slot3].includes("üí∞")) {
              mineData.upgradeLevel++;
              upgrades.push("Currency Output +1");
            }
            if ([slot1, slot2, slot3].includes("üîß")) {
              mineData.upgradeLevel++;
              upgrades.push("Mecha Part Drop +1%");
            }
            if ([slot1, slot2, slot3].includes("üìà")) {
              mineData.upgradeLevel++;
              upgrades.push("Output Multiplier +0.1x");
            }

            if (upgrades.length > 0) {
              resultDiv.innerHTML = `<span style="color: #27ae60;">üéâ Success! ${upgrades.join(
                ", "
              )}</span>`;
              logMessage(`üîß Mine upgraded! ${upgrades.join(", ")}`, "success");
            }
          } else {
            resultDiv.innerHTML = `<span style="color: #f39c12;">Partial success - minor improvement!</span>`;
            logMessage("üîß Minor mining improvement!", "success");
          }
        }
      }

      // Final Boss Functions
      function startFinalBoss() {
        gameState.combat.active = true;

        // Set up ultimate stats
        gameState.combat.mechaStats = {
          hp: 500,
          maxHp: 500,
          energy: 30,
          maxEnergy: 30,
          attack: 50,
          defense: 25,
        };

        gameState.combat.monsterStats = {
          hp: 1000,
          maxHp: 1000,
          energy: 50,
          maxEnergy: 50,
          attack: 40,
          defense: 20,
        };

        showScreen("combat-screen");

        // Update display for final boss
        document.getElementById("mecha-name").textContent = "Ultimate Mecha";
        document.getElementById("monster-name").textContent =
          "üëë Slime King üëë";

        setupCombatScreen();
        logMessage(
          "üëë The final battle begins! Defeat the Slime King!",
          "combat"
        );
      }

      // Navigation Functions
      function returnToMineSelection() {
        showScreen("mine-selection-screen");
        updateMineSelection();
      }

      function returnToMining() {
        showScreen("mining-screen");
        setupMiningScreen();
      }

      // Utility Functions
      function logMessage(message, type = "normal") {
        const logs = document.querySelectorAll(".game-log");
        logs.forEach((log) => {
          const entry = document.createElement("div");
          entry.className = `log-entry ${type}`;
          entry.textContent = message;
          log.appendChild(entry);
          log.scrollTop = log.scrollHeight;

          // Keep only last 20 messages
          while (log.children.length > 20) {
            log.removeChild(log.firstChild);
          }
        });
      }

      function showExchangeOptions(currency) {
        // Simple exchange - just show alert for now
        const amount = gameState.currencies[currency];
        const exchangeRate = 0.5; // Poor exchange rate as mentioned in GDD
        const result = Math.floor(amount * exchangeRate);

        if (
          confirm(
            `Exchange ${amount} ${getCurrencyIcon(
              currency
            )} for ${result} of another currency? (50% exchange rate)`
          )
        ) {
          // For demo purposes, exchange to shells
          gameState.currencies[currency] = 0;
          gameState.currencies.shells += result;
          updateTradingPost();
          logMessage(
            `üí± Exchanged ${amount} ${getCurrencyIcon(
              currency
            )} for ${result} shells`,
            "success"
          );
        }
      }

      // Override victory condition
      const originalWinCombat = winCombat;
      winCombat = function () {
        if (gameState.combat.monsterStats.maxHp >= 1000) {
          // Final boss defeated
          logMessage("üéâ SLIME KING DEFEATED! THE COLONY IS SAVED!", "success");
          setTimeout(() => showScreen("victory-screen"), 2000);
          return;
        }
        originalWinCombat();
      };

      // Initialize game
      document.addEventListener("DOMContentLoaded", function () {
        logMessage(
          "ü§ñ AstroGuide: Welcome to Mecha X Monster! Ready to start your adventure?"
        );
      });
    </script>
  </body>
</html>
